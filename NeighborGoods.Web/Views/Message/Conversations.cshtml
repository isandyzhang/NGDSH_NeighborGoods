@model NeighborGoods.Web.Models.ViewModels.ConversationListViewModel

@{
    ViewData["Title"] = "我的訊息";
}

<div class="container mt-4">
    <h2 class="mb-4">我的訊息</h2>

    @if (Model.Conversations == null || !Model.Conversations.Any())
    {
        <div class="card">
            <div class="card-body text-center py-5">
                <p class="text-muted mb-3">您還沒有任何對話</p>
                <a asp-controller="Home" asp-action="Index" class="btn btn-primary">
                    瀏覽商品
                </a>
            </div>
        </div>
    }
    else
    {
        <div class="conversation-list">
            @foreach (var conversation in Model.Conversations)
            {
                // 取得名字首字母作為大頭貼
                var firstChar = string.IsNullOrEmpty(conversation.OtherUserDisplayName) 
                    ? "?" 
                    : conversation.OtherUserDisplayName[0].ToString();
                
                // 根據首字母生成背景色（簡單的顏色映射）
                var colors = new[] { "#007bff", "#28a745", "#dc3545", "#ffc107", "#17a2b8", "#6f42c1", "#e83e8c", "#fd7e14" };
                var colorIndex = Math.Abs(conversation.OtherUserDisplayName?.GetHashCode() ?? 0) % colors.Length;
                var avatarColor = colors[colorIndex];
                
                <a asp-controller="Message" asp-action="Chat" asp-route-conversationId="@conversation.ConversationId" asp-route-listingId="@conversation.ListingId"
                   class="conversation-item">
                    <div class="conversation-content">
                        <!-- 左邊：大頭貼 -->
                        <div class="avatar" style="background-color: @avatarColor;">
                            <span>@firstChar</span>
                        </div>
                        
                        <!-- 中間：使用者名稱和訊息 -->
                        <div class="conversation-info">
                            <div class="conversation-header">
                                <span class="user-name">@conversation.OtherUserDisplayName</span>
                            </div>
                            <div class="conversation-message">
                                @if (!string.IsNullOrEmpty(conversation.LastMessage))
                                {
                                    <span class="message-text">@conversation.LastMessage</span>
                                }
                                else
                                {
                                    <span class="message-text text-muted">尚無訊息</span>
                                }
                            </div>
                        </div>
                    </div>
                    
                    <!-- 右邊：商品縮圖、日期、未讀數量 -->
                    <div class="conversation-meta">
                        @if (!string.IsNullOrEmpty(conversation.ListingFirstImageUrl))
                        {
                            <div class="listing-thumbnail">
                                <img src="@conversation.ListingFirstImageUrl" alt="@conversation.ListingTitle" />
                            </div>
                        }
                        <div class="conversation-time-badge">
                            @if (conversation.LastMessageTime.HasValue)
                            {
                                <span class="message-time">@conversation.LastMessageTime.Value.ToString("MM/dd")</span>
                            }
                            @if (conversation.UnreadCount > 0)
                            {
                                <span class="unread-badge">@conversation.UnreadCount</span>
                            }
                        </div>
                    </div>
                </a>
            }
        </div>
    }
</div>

@section Scripts {
    <style>
        .conversation-list {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .conversation-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            text-decoration: none;
            color: inherit;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.2s;
            gap: 12px;
        }

        .conversation-item:hover {
            background-color: #f8f9fa;
            text-decoration: none;
            color: inherit;
        }

        .conversation-item:last-child {
            border-bottom: none;
        }

        .conversation-content {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 0;
            gap: 12px;
        }

        /* 大頭貼 */
        .avatar {
            width: 50px;
            height: 50px;
            min-width: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 20px;
            flex-shrink: 0;
        }

        .avatar span {
            line-height: 1;
        }

        /* 對話資訊 */
        .conversation-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .conversation-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-name {
            font-weight: 600;
            font-size: 16px;
            color: #212529;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-message {
            min-width: 0;
        }

        .message-text {
            font-size: 14px;
            color: #6c757d;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.4;
        }

        /* 右邊區域：商品縮圖、日期、未讀數量 */
        .conversation-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            flex-shrink: 0;
        }

        /* 商品縮圖 */
        .listing-thumbnail {
            width: 60px;
            height: 60px;
            min-width: 60px;
            border-radius: 8px;
            overflow: hidden;
            background-color: #f8f9fa;
            flex-shrink: 0;
        }

        .listing-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 日期和未讀數量 */
        .conversation-time-badge {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .message-time {
            font-size: 12px;
            color: #6c757d;
            white-space: nowrap;
        }

        .unread-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            background-color: #007bff;
            color: white;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
        }

        /* 手機優化 */
        @@media (max-width: 576px) {
            .conversation-item {
                padding: 12px;
            }

            .avatar {
                width: 45px;
                height: 45px;
                min-width: 45px;
                font-size: 18px;
            }

            .listing-thumbnail {
                width: 50px;
                height: 50px;
                min-width: 50px;
            }

            .user-name {
                font-size: 15px;
            }

            .message-text {
                font-size: 13px;
            }
        }
    </style>
}

