@model NeighborGoods.Web.Models.ViewModels.MyListingsViewModel
@using NeighborGoods.Web.Models.Enums

@{
    ViewData["Title"] = "我的商品";
}

<div class="container mt-4">
    <h2 class="mb-4">我的商品</h2>

    @if (Model.Listings == null || !Model.Listings.Any())
    {
        <div class="card">
            <div class="card-body text-center py-5">
                <p class="text-muted mb-3">您還沒有刊登任何商品</p>
                <a asp-controller="Listing" asp-action="Create" class="btn btn-primary btn-lg" style="min-height: 50px; font-size: 1.1rem;">
                    立即刊登商品
                </a>
            </div>
        </div>
    }
    else
    {
        <!-- 篩選按鈕（手機友善） -->
        <div class="mb-3">
            <div class="btn-group w-100" role="group" style="min-height: 44px;">
                <button type="button" class="btn btn-outline-primary filter-btn active" data-status="all">
                    全部 (@Model.Listings.Count)
                </button>
                <button type="button" class="btn btn-outline-primary filter-btn" data-status="@((int)ListingStatus.Active)">
                    上架中 (@Model.Listings.Count(l => l.Status == ListingStatus.Active))
                </button>
                <button type="button" class="btn btn-outline-primary filter-btn" data-status="@((int)ListingStatus.Reserved)">
                    保留中 (@Model.Listings.Count(l => l.Status == ListingStatus.Reserved))
                </button>
                <button type="button" class="btn btn-outline-primary filter-btn" data-status="completed">
                    成交 (@Model.Listings.Count(l => l.Status == ListingStatus.Sold || l.Status == ListingStatus.Donated))
                </button>
            </div>
        </div>

        <!-- 商品列表 -->
        <div class="row g-3" id="listingsContainer">
            @foreach (var listing in Model.Listings)
            {
                var statusClass = listing.Status switch
                {
                    ListingStatus.Active => "success",
                    ListingStatus.Reserved => "warning",
                    ListingStatus.Sold => "info",
                    ListingStatus.Donated => "primary",
                    ListingStatus.Inactive => "secondary",
                    _ => "secondary"
                };

                var statusText = listing.Status switch
                {
                    ListingStatus.Active => "上架中",
                    ListingStatus.Reserved => "保留中",
                    ListingStatus.Sold => "已售出",
                    ListingStatus.Donated => "已捐贈",
                    ListingStatus.Inactive => "已下架",
                    _ => listing.Status.ToString()
                };

                var isCompleted = listing.Status == ListingStatus.Sold || listing.Status == ListingStatus.Donated;

                <div class="col-12 col-md-6 col-lg-4 listing-item" 
                     data-status="@((int)listing.Status)" 
                     data-completed="@(isCompleted ? "true" : "false")">
                    <div class="card h-100 my-listing-card" 
                         onclick="window.location.href='@Url.Action("Details", "Listing", new { id = listing.Id })'">
                        @if (!string.IsNullOrEmpty(listing.FirstImageUrl))
                        {
                            <img src="@listing.FirstImageUrl" class="card-img-top my-listing-card-image" alt="@listing.Title" loading="lazy">
                        }
                        else
                        {
                            <div class="card-img-top bg-light d-flex align-items-center justify-content-center my-listing-card-image">
                                <span class="text-muted">無圖片</span>
                            </div>
                        }
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title mb-2">@listing.Title</h5>
                            <div class="mb-2 my-listing-price-section">
                                @if (listing.IsFree)
                                {
                                    <span class="badge bg-success">免費</span>
                                }
                                else
                                {
                                    <span class="text-primary fw-bold">NT$ @listing.Price.ToString("N0")</span>
                                }
                                @if (listing.IsCharity)
                                {
                                    <span class="badge bg-danger ms-1">愛心商品</span>
                                }
                                @if (listing.IsTradeable)
                                {
                                    <span class="badge bg-info ms-1">可易物</span>
                                }
                            </div>
                            <div class="mb-2">
                                <span class="badge bg-@statusClass">@statusText</span>
                            </div>
                            <div class="mt-auto">
                                <small class="text-muted d-block mb-2">
                                    刊登時間：@listing.CreatedAt.ToString("yyyy/MM/dd")
                                </small>
                                @if (listing.Status == ListingStatus.Active)
                                {
                                    <a asp-action="Edit" asp-route-id="@listing.Id" 
                                       class="btn btn-sm btn-outline-primary w-100"
                                       onclick="event.stopPropagation();">
                                        編輯商品
                                    </a>
                                }
                                else if (listing.Status == ListingStatus.Inactive)
                                {
                                    <div class="d-flex gap-2" onclick="event.stopPropagation();">
                                        <a asp-action="Edit" asp-route-id="@listing.Id" 
                                           class="btn btn-sm btn-outline-primary flex-fill">
                                            編輯
                                        </a>
                                        <form asp-action="Reactivate" asp-route-id="@listing.Id" method="post" 
                                              class="flex-fill">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-sm btn-success w-100">
                                                重新上架
                                            </button>
                                        </form>
                                    </div>
                                    <form asp-action="Delete" asp-route-id="@listing.Id" method="post" 
                                          onsubmit="return confirm('確定要永久刪除這個商品嗎？此操作無法復原，所有商品圖片也會被刪除。');"
                                          class="w-100 mt-2">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-sm btn-danger w-100">
                                            永久刪除
                                        </button>
                                    </form>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@section Scripts {
    <script>
        // 篩選功能
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // 更新按鈕狀態
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                const status = this.dataset.status;
                const items = document.querySelectorAll('.listing-item');

                items.forEach(item => {
                    if (status === 'all') {
                        item.style.display = '';
                    } else if (status === 'completed') {
                        const isCompleted = item.dataset.completed === 'true';
                        item.style.display = isCompleted ? '' : 'none';
                    } else {
                        const itemStatus = item.dataset.status;
                        item.style.display = itemStatus === status ? '' : 'none';
                    }
                });
            });
        });
    </script>

    <style>
        /* 手機友善設計 */
        @@media (max-width: 576px) {
            .my-listing-card {
                border-radius: 8px;
            }
            
            .btn-group {
                flex-wrap: wrap;
            }
            
            .btn-group .btn {
                flex: 1 1 auto;
                min-width: 0;
                font-size: 14px;
                padding: 8px 4px;
            }
        }
    </style>
}

