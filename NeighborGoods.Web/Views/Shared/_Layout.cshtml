@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using NeighborGoods.Web.Models.Entities
@using NeighborGoods.Web.Data
@inject UserManager<ApplicationUser> UserManager
@inject AppDbContext DbContext

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - 南港社宅社區專屬二手交易平台</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/NeighborGoods.Web.styles.css" asp-append-version="true" />
</head>
<body>
    <!-- 側邊欄背景遮罩 -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <!-- 側邊欄選單 -->
    <div class="sidebar-menu" id="sidebarMenu">
        <div class="sidebar-header">
            <h5 class="mb-0">選單</h5>
            <button type="button" class="btn-close" id="sidebarClose" aria-label="Close"></button>
        </div>
        <div class="sidebar-content">
            <ul class="sidebar-nav">
                @if (User?.Identity?.IsAuthenticated ?? false)
                {
                    var appUser = await UserManager.GetUserAsync(User);
                    var displayName = appUser?.DisplayName ?? User.Identity!.Name;
                    var unreadCount = 0;
                    if (appUser != null)
                    {
                        try
                        {
                            var conversations = await DbContext.Conversations
                                .Include(c => c.Messages.OrderByDescending(m => m.CreatedAt).Take(1))
                                .Where(c => c.Participant1Id == appUser.Id || c.Participant2Id == appUser.Id)
                                .ToListAsync();
                            
                            foreach (var conversation in conversations)
                            {
                                var lastMessage = conversation.Messages
                                    .OrderByDescending(m => m.CreatedAt)
                                    .FirstOrDefault();
                                
                                if (lastMessage != null && lastMessage.SenderId != appUser.Id)
                                {
                                    unreadCount++;
                                }
                            }
                        }
                        catch
                        {
                            unreadCount = 0;
                        }
                    }
                    
                    <li class="sidebar-nav-item">
                        <span class="sidebar-nav-text">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-person-circle me-2" viewBox="0 0 16 16">
                                <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
                                <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"/>
                            </svg>
                            哈囉，@displayName
                        </span>
                    </li>
                    <li class="sidebar-nav-item">
                        <a class="sidebar-nav-link" asp-area="" asp-controller="Home" asp-action="Index">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-grid me-2" viewBox="0 0 16 16">
                                <path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5zM2.5 2a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5zm6.5 4A1.5 1.5 0 0 1 10.5 4h3A1.5 1.5 0 0 1 15 5.5v3A1.5 1.5 0 0 1 13.5 10h-3A1.5 1.5 0 0 1 9 8.5zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5zm-7 4A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5zm6.5.5A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5z"/>
                            </svg>
                            瀏覽商品
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a class="sidebar-nav-link" asp-controller="Listing" asp-action="Create">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-plus-circle me-2" viewBox="0 0 16 16">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
                            </svg>
                            刊登商品
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a class="sidebar-nav-link" asp-controller="Message" asp-action="Conversations">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-envelope me-2" viewBox="0 0 16 16">
                                <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1zm13 2.383-4.708 2.825L15 11.105zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741M1 11.105l4.708-2.897L1 5.383z"/>
                            </svg>
                            我的訊息
                            @if (unreadCount > 0)
                            {
                                <span class="unread-badge">@unreadCount</span>
                            }
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a class="sidebar-nav-link" asp-controller="Account" asp-action="Profile">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-person-gear me-2" viewBox="0 0 16 16">
                                <path d="M11 5a3 3 0 1 1-6 0 3 3 0 0 1 6 0M8 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4m.256 7a4.5 4.5 0 0 1-.229-1.004H3c.001-.246.154-.986.832-1.664C4.484 10.68 5.711 10 8 10c.26 0 .507.009.74.025.226-.341.496-.65.804-.918C9.077 9.038 8.564 9 8 9c-2.42 0-3.879.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h7.792c.256-.717.54-1.392.864-2.024.302-.632.655-1.218 1.04-1.746m6.628-4.559c-.254-.415-.582-.79-.97-1.11a.5.5 0 1 0-.748.662c.27.24.52.51.73.81.075.096.15.193.22.29.051.1.101.2.145.3.013.03.023.06.033.09l.01.028a.5.5 0 0 0 .9-.01c.01-.02.02-.05.03-.09l.01-.028a5.5 5.5 0 0 0 .145-.3c.07-.097.145-.194.22-.29.21-.3.46-.57.73-.81a.5.5 0 1 0-.748-.662c-.388.32-.716.695-.97 1.11a.5.5 0 1 0 .896.445m-2.97-1.11a.5.5 0 0 0-.748-.662c-.388.32-.716.695-.97 1.11a.5.5 0 1 0 .896.446c.254-.415.582-.79.97-1.11z"/>
                            </svg>
                            個人資料
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a class="sidebar-nav-link" asp-area="" asp-controller="Home" asp-action="Terms">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-file-text me-2" viewBox="0 0 16 16">
                                <path d="M5 4a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1zm0 2a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1zM5 9a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1zm0 2a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1z"/>
                                <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2zm10-1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1"/>
                            </svg>
                            使用條款
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a class="sidebar-nav-link" asp-area="" asp-controller="Home" asp-action="Privacy">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-shield-lock me-2" viewBox="0 0 16 16">
                                <path d="M5.338 1.59a61.44 61.44 0 0 0-2.837.856.481.481 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.725 10.725 0 0 0 2.287 2.233c.346.244.652.42.893.533.12.057.218.095.293.118a.55.55 0 0 0 .101.025.615.615 0 0 0 .1-.025c.076-.023.174-.061.294-.118.24-.113.547-.29.893-.533a10.726 10.726 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM5.232.119a61.44 61.44 0 0 1 2.837.856c.1.033.2.068.3.102a.5.5 0 0 1 .707 0c.1-.034.2-.069.3-.102 1.087-.296 2.186-.642 2.837-.855a.48.48 0 0 1 .328-.39C13.591.439 12.742.5 12 .5c-.742 0-1.591-.061-2.168-.237a.48.48 0 0 1-.328-.39z"/>
                                <path d="M9.5 6.5a1.5 1.5 0 0 1-1 1.415l.385 1.99a.5.5 0 0 1-.491.595h-.788a.5.5 0 0 1-.49-.595l.384-1.99a1.5 1.5 0 1 1 2-1.415m-1.5.5a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1"/>
                            </svg>
                            隱私條款
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <form asp-controller="Account" asp-action="Logout" method="post" class="d-inline">
                            <button type="submit" class="btn btn-link sidebar-nav-link p-0 text-start w-100">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-box-arrow-right me-2" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z"/>
                                    <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z"/>
                                </svg>
                                登出
                            </button>
                        </form>
                    </li>
                }
                else
                {
                    <li class="sidebar-nav-item">
                        <a class="sidebar-nav-link" asp-area="" asp-controller="Home" asp-action="Index">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-grid me-2" viewBox="0 0 16 16">
                                <path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5zM2.5 2a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5zm6.5 4A1.5 1.5 0 0 1 10.5 4h3A1.5 1.5 0 0 1 15 5.5v3A1.5 1.5 0 0 1 13.5 10h-3A1.5 1.5 0 0 1 9 8.5zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5zm-7 4A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5zm6.5.5A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5z"/>
                            </svg>
                            瀏覽商品
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a class="sidebar-nav-link" asp-area="" asp-controller="Home" asp-action="Terms">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-file-text me-2" viewBox="0 0 16 16">
                                <path d="M5 4a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1zm0 2a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1zM5 9a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1zm0 2a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1z"/>
                                <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2zm10-1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1"/>
                            </svg>
                            使用條款
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a class="sidebar-nav-link" asp-area="" asp-controller="Home" asp-action="Privacy">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-shield-lock me-2" viewBox="0 0 16 16">
                                <path d="M5.338 1.59a61.44 61.44 0 0 0-2.837.856.481.481 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.725 10.725 0 0 0 2.287 2.233c.346.244.652.42.893.533.12.057.218.095.293.118a.55.55 0 0 0 .101.025.615.615 0 0 0 .1-.025c.076-.023.174-.061.294-.118.24-.113.547-.29.893-.533a10.726 10.726 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM5.232.119a61.44 61.44 0 0 1 2.837.856c.1.033.2.068.3.102a.5.5 0 0 1 .707 0c.1-.034.2-.069.3-.102 1.087-.296 2.186-.642 2.837-.855a.48.48 0 0 1 .328-.39C13.591.439 12.742.5 12 .5c-.742 0-1.591-.061-2.168-.237a.48.48 0 0 1-.328-.39z"/>
                                <path d="M9.5 6.5a1.5 1.5 0 0 1-1 1.415l.385 1.99a.5.5 0 0 1-.491.595h-.788a.5.5 0 0 1-.49-.595l.384-1.99a1.5 1.5 0 1 1 2-1.415m-1.5.5a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1"/>
                            </svg>
                            隱私條款
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a class="sidebar-nav-link" asp-controller="Account" asp-action="Login">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-box-arrow-in-right me-2" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M6 3.5a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-2a.5.5 0 0 0-1 0v2A1.5 1.5 0 0 0 6.5 15h8a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-8A1.5 1.5 0 0 0 5 3.5v2a.5.5 0 0 0 1 0z"/>
                                <path fill-rule="evenodd" d="M11.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H1.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z"/>
                            </svg>
                            登入
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a class="sidebar-nav-link" asp-controller="Account" asp-action="Register">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-person-plus me-2" viewBox="0 0 16 16">
                                <path d="M6 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6m2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0m4 8c0 1-1 1-1 1H1s-1 0-1-1 1-4 6-4 6 3 6 4m-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10s-3.516.68-4.168 1.332c-.678.678-.83 1.418-.832 1.664zm5.252-7.5a.5.5 0 0 1 .5.5v2h2a.5.5 0 0 1 0 1h-2v2a.5.5 0 0 1-1 0v-2h-2a.5.5 0 0 1 0-1h2v-2a.5.5 0 0 1 .5-.5"/>
                            </svg>
                            註冊
                        </a>
                    </li>
                }
            </ul>
        </div>
    </div>

    <header>
        <nav class="navbar navbar-light bg-white border-bottom box-shadow mb-3">
            <div class="container-fluid">
                <button class="navbar-toggler me-2" type="button" id="sidebarToggle" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <a class="navbar-brand" asp-area="" asp-controller="Home" asp-action="Index">南港社宅社區專屬二手交易平台</a>
            </div>
        </nav>
    </header>
    <div class="container">
        <main role="main" class="pb-3">
            @RenderBody()
        </main>
    </div>

    <footer class="border-top footer text-muted">
        <div class="container">
            &copy; 2025 - 南港社宅社區專屬二手交易平台 - <a asp-area="" asp-controller="Home" asp-action="Privacy">隱私條款</a>
        </div>
    </footer>

    <!-- 免責條款同意 Modal -->
    <div class="modal fade" id="disclaimerModal" tabindex="-1" aria-labelledby="disclaimerModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="disclaimerModalLabel">使用條款與免責聲明</h5>
                </div>
                <div class="modal-body">
                    <h6 class="fw-bold">歡迎使用南港社宅社區專屬二手交易平台</h6>
                    <p>本平台為社宅專用的商品交換販賣服務，請在使用前仔細閱讀以下條款：</p>
                    <ul>
                        <li><strong>平台性質：</strong>本平台僅提供商品資訊展示與聯絡服務，不參與實際交易過程。</li>
                        <li><strong>交易方式：</strong>所有交易必須在社區內當面完成，禁止使用郵寄或其他遠距交易方式。</li>
                        <li><strong>商品確認：</strong>請在面交時當場確認商品狀況，確認無誤後再完成交易。</li>
                        <li><strong>交易糾紛：</strong>網站方不處理任何交易糾紛，買賣雙方需自行協商解決。</li>
                        <li><strong>付款方式：</strong>建議使用現金交易，以減少交易糾紛。</li>
                        <li><strong>免責聲明：</strong>平台僅提供資訊服務，不對商品品質、交易安全或任何交易結果負責。</li>
                    </ul>
                    <p class="text-danger fw-bold mb-0">點擊「我同意」即表示您已閱讀並同意以上條款。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary btn-lg w-100" id="disclaimerAccept">我同意</button>
                </div>
            </div>
        </div>
    </div>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
