# NeighborGoods 愛心社區二手

> 🏘️ 社區型二手交易 ＋ 愛心捐贈平台  
> 純面交、無金流，站內私訊、隱私不外露。支援「愛心商品」標註，讓公益團體可主動認領。

---

## 📑 目錄

- [專案概覽](#專案概覽)
- [核心功能](#核心功能)
- [交易流程](#交易流程)
- [Azure 服務架構](#azure-服務架構)
- [使用者與角色](#使用者與角色)
- [登入機制](#登入機制)
- [資料庫設計](#資料庫設計)
- [頁面規劃](#頁面規劃)
- [專案結構](#專案結構)
- [快速開始](#快速開始)
- [里程碑](#里程碑)

---

## 專案概覽

**NeighborGoods** 是一個專為社區設計的二手物品交易與愛心捐贈平台。

| 特色 | 說明 |
|------|------|
| 🔒 **隱私優先** | 站內私訊不外露個資 |
| 💬 **即時互動** | SignalR 實現即時私訊通知 |
| 💝 **愛心捐贈** | 物品可標註愛心商品，公益團體可主動私訊認領 |
| 🤝 **純面交** | 無金流、無貨運，交易透過私訊約定面交完成 |
| ⭐ **交易評價** | 完成交易後，買家可對賣家評分 |

---

## 核心功能

### 📦 商品刊登
- 標題、詳細描述
- 商品分類（傢俱、家電、服飾、書籍、玩具、運動、3C、生活用品、其他）
- 新舊程度（全新、近全新、良好、普通、歲月痕跡）
- 價格輸入 + 「免費索取」選項
- 「愛心商品」標註（開放公益團體認領）
- 面交地點（北棟管理室、南棟管理室、風雨操場）
- 圖片上傳（最多 5 張）
- 商品狀態：上架 → 保留 → 已售出/已捐贈 → 下架

### 💬 站內私訊
- 一對一私訊（SignalR 即時推播）
- 未讀訊息提醒
- 私訊可關聯到特定商品

### 🔍 搜尋與篩選
- 依商品分類篩選
- 依價格範圍篩選（含免費索取）
- 依商品狀態篩選
- 關鍵字搜尋

### 💝 愛心捐贈
- 標註愛心商品
- 公益團體可瀏覽愛心商品並發送認領私訊
- 刊登者同意後，商品狀態改為「已捐贈」

### 🤝 交易模式
- 僅支援面交（無金流、無貨運）
- 買賣雙方透過站內私訊溝通
- 私訊介面 / 我的商品頁 提供「完成交易」按鈕

### ⭐ 交易評價
- 交易完成後，買家可對賣家評分（1-5 星）
- 可附上評價內容（選填）
- 賣家個人頁面顯示平均評分

> ⚠️ **免責聲明**：本平台僅提供物品刊登與媒合服務，不介入任何交易糾紛。

---

## 交易流程

### 正常流程

```
  刊登者                                              購買者
    │                                                    │
    │  ① 刊登商品                                        │
    │  狀態：【上架中】                                   │
    │                                                    │
    │                         ②  瀏覽商品                │
    │                         ③  發送私訊詢問            │
    │◀─────────────────────────────────────────────────│
    │                                                    │
    │  ④ 收到私訊通知                                    │
    │  ⑤ 回覆私訊，約定面交時間地點                       │
    │─────────────────────────────────────────────────▶│
    │                                                    │
    │  ⑥ 確認要賣給此人                                  │
    │  點擊【設為保留中】                                 │
    │  狀態：【保留中】                                   │
    │                                                    │
    │◀═══════════════════════════════════════════════▶│
    │                      ⑦ 面交                        │
    │                                                    │
    │  ⑧ 面交完成                                        │
    │  點擊【完成交易】                                   │
    │  狀態：【已售出】或【已捐贈】                        │
    │                                                    │
    │                         ⑨ 收到「交易完成」通知      │
    │                         ⑩ 對賣家留下評價 ⭐         │
    │◀─────────────────────────────────────────────────│
    │                                                    │
    ▼                                                    ▼
  結束                                                  結束
```

### 例外情況

```
【購買者爽約/反悔】
  刊登者點擊【取消保留】→ 狀態回到【上架中】

【刊登者不想賣了】
  刊登者點擊【下架商品】→ 狀態變成【已下架】

【多人同時詢問】
  刊登者選擇其中一人 → 設為【保留中】
  其他人看到「已保留」，知道可能沒機會
```

### 狀態流轉

```
                    ┌─────────┐
                    │  刊登   │
                    └────┬────┘
                         │
                         ▼
                  ┌─────────────┐
        ┌────────│   上架中    │────────┐
        │        └──────┬──────┘        │
        │               │               │
        │ [下架]        │ [保留]        │
        │               ▼               │
        │        ┌─────────────┐        │
        │        │   保留中    │        │
        │        └──────┬──────┘        │
        │               │               │
        │    ┌──────────┼──────────┐    │
        │    │          │          │    │
        │ [取消保留]    │    [完成交易]  │
        │    │          │          │    │
        │    ▼          │          ▼    │
        │  回到上架中    │   ┌───────────┴───────────┐
        │               │   │                       │
        │               │   ▼                       ▼
        │           ┌─────────┐             ┌─────────────┐
        │           │ 已售出  │             │   已捐贈    │
        │           └─────────┘             │ (愛心商品)  │
        │                                   └─────────────┘
        │
        ▼
  ┌─────────────┐
  │   已下架    │
  └─────────────┘
```

---

## Azure 服務架構

```
┌─────────────────────────────────────────────────────┐
│                    Azure Cloud                       │
├─────────────────────────────────────────────────────┤
│                                                      │
│   ┌─────────────────┐      ┌─────────────────────┐  │
│   │  App Service    │      │  Azure SignalR      │  │
│   │  (Linux/.NET 8) │ ←──→ │  (即時私訊)         │  │
│   │  MVC + Razor    │      │                     │  │
│   └────────┬────────┘      └─────────────────────┘  │
│            │                                         │
│   ┌────────┴────────┐      ┌─────────────────────┐  │
│   │  Azure SQL      │      │  Azure Blob Storage │  │
│   │  (Serverless)   │      │  (圖片儲存)         │  │
│   └─────────────────┘      └─────────────────────┘  │
│                                                      │
└─────────────────────────────────────────────────────┘
```

### 服務清單

| 服務 | 用途 | 方案建議 |
|------|------|----------|
| **Azure App Service** | 網站主機 | Linux B1/B2 |
| **Azure SQL Database** | 資料儲存 | Serverless (省成本) |
| **Azure Blob Storage** | 圖片儲存 | Standard LRS |
| **Azure SignalR Service** | 即時私訊 | Free (20 連線) 或 Standard |

---

## 使用者與角色

### 角色定義

| 角色 | 說明 | 權限 |
|------|------|------|
| **一般用戶** | 社區住戶 | 刊登商品、私訊、購買/索取、評價 |
| **公益團體** | 審核通過的公益組織 | 瀏覽愛心商品、發送認領私訊 |
| **版主** | 社區志工 | 強制下架商品 |
| **管理員** | 系統管理者 | 全部權限 + 帳號管理 |

### 權限矩陣

| 功能 | 一般用戶 | 公益團體 | 版主 | 管理員 |
|------|:--------:|:--------:|:----:|:------:|
| 瀏覽商品 | ✓ | ✓ | ✓ | ✓ |
| 刊登商品 | ✓ | ✗ | ✓ | ✓ |
| 站內私訊 | ✓ | ✓ | ✓ | ✓ |
| 交易評價 | ✓ | ✓ | ✓ | ✓ |
| 瀏覽愛心商品 | ✓ | ✓ | ✓ | ✓ |
| 認領愛心商品 | ✗ | ✓ | ✗ | ✓ |
| 強制下架 | ✗ | ✗ | ✓ | ✓ |
| 帳號管理 | ✗ | ✗ | ✗ | ✓ |
| 建立公益團體帳號 | ✗ | ✗ | ✗ | ✓ |

---

## 登入機制

### 登入方式

```
┌─────────────────────────────────────────────────────┐
│                    登入選項                          │
├─────────────────────────────────────────────────────┤
│                                                      │
│   ┌─────────────────┐    ┌─────────────────────┐    │
│   │   LINE 登入      │    │   帳號密碼登入       │    │
│   │   (OIDC)        │    │                     │    │
│   └────────┬────────┘    └──────────┬──────────┘    │
│            │                        │               │
│            └───────────┬────────────┘               │
│                        ▼                            │
│            ┌─────────────────────┐                  │
│            │     Users 資料表     │                  │
│            └─────────────────────┘                  │
└─────────────────────────────────────────────────────┘
```

### 登入流程

**LINE 登入（新用戶）：**
1. 點擊「LINE 登入」
2. LINE 授權後取得 LineUserId
3. 若 DB 無此 LineUserId → 導向「建立帳號」頁面
4. 填寫 Username、DisplayName（Email 選填）
5. 建立帳號並綁定 LINE

**LINE 登入（已有帳號）：**
1. 點擊「LINE 登入」
2. LINE 授權後取得 LineUserId
3. 查詢 DB 找到對應帳號 → 直接登入

**帳號密碼註冊：**
1. 填寫 Username、Password、DisplayName（Email 選填）
2. 建立帳號
3. 之後可在設定頁綁定 LINE

**帳號密碼登入：**
1. 輸入 Username、Password
2. 驗證成功 → 登入

---

## 資料庫設計

### ER 關聯圖

```
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│     Users       │       │    Listings     │       │  ListingImages  │
├─────────────────┤       ├─────────────────┤       ├─────────────────┤
│ Id (PK)         │──┐    │ Id (PK)         │──────▶│ Id (PK)         │
│ Username        │  │    │ Title           │   1:N │ ListingId (FK)  │
│ DisplayName     │  │    │ Description     │       │ ImageUrl        │
│ PasswordHash    │  └───▶│ SellerId (FK)   │       │ SortOrder       │
│ Email           │   1:N │ Category        │       │ CreatedAt       │
│ LineUserId      │       │ Condition       │       └─────────────────┘
│ Role            │       │ Price           │
│ CreatedAt       │       │ IsFree          │       ┌─────────────────┐
└─────────────────┘       │ IsCharity       │       │    Reviews      │
        │                 │ Location        │       ├─────────────────┤
        │                 │ Status          │◀──────│ Id (PK)         │
        │                 │ CreatedAt       │   1:1 │ ListingId (FK)  │
        │                 │ UpdatedAt       │       │ SellerId (FK)   │
        │                 └─────────────────┘       │ BuyerId (FK)    │
        │                                           │ Rating          │
        │                 ┌─────────────────┐       │ Content         │
        │                 │    Messages     │       │ CreatedAt       │
        │                 ├─────────────────┤       └─────────────────┘
        └────────────────▶│ Id (PK)         │
                      1:N │ SenderId (FK)   │
                          │ ReceiverId (FK) │
                          │ ListingId (FK)  │
                          │ Content         │
                          │ IsRead          │
                          │ CreatedAt       │
                          └─────────────────┘
```

### 資料表總覽

| 資料表 | 用途 |
|--------|------|
| **Users** | 使用者帳號 |
| **Listings** | 商品刊登 |
| **ListingImages** | 商品圖片（1:N） |
| **Messages** | 站內私訊 |
| **Reviews** | 交易評價（1:1 per Listing） |

### Users（使用者）

| 欄位 | 型別 | 說明 |
|------|------|------|
| Id | GUID | 主鍵 |
| Username | string | 帳號（唯一） |
| DisplayName | string | 顯示名稱 |
| PasswordHash | string? | 密碼雜湊（LINE 用戶可 null） |
| Email | string? | 電子郵件（選填） |
| LineUserId | string? | LINE 用戶 ID |
| Role | enum | User / Charity / Moderator / Admin |
| CreatedAt | DateTime | 建立時間 |

> 📌 刪除帳號時，關聯的 Listings、Messages、Reviews 一併刪除（Cascade Delete）

### Listings（商品）

| 欄位 | 型別 | 說明 |
|------|------|------|
| Id | GUID | 主鍵 |
| Title | string | 商品名稱 |
| Description | string | 詳細描述 |
| Category | enum | 分類 |
| Condition | enum | 新舊程度 |
| Price | decimal | 價格 |
| IsFree | bool | 是否免費索取 |
| IsCharity | bool | 是否愛心商品 |
| Location | enum | 面交地點 |
| Status | enum | 商品狀態 |
| SellerId | GUID | FK → Users |
| CreatedAt | DateTime | 建立時間 |
| UpdatedAt | DateTime | 更新時間 |

**Category（分類）枚舉：**
| 值 | 說明 |
|----|------|
| Furniture | 傢俱 |
| Appliance | 家電 |
| Clothing | 服飾 |
| Book | 書籍 |
| Toy | 玩具 |
| Sports | 運動 |
| Electronics | 3C |
| Daily | 生活用品 |
| Other | 其他 |

**Condition（新舊程度）枚舉：**
| 值 | 說明 |
|----|------|
| New | 全新 |
| LikeNew | 近全新 |
| Good | 良好 |
| Fair | 普通 |
| WellUsed | 歲月痕跡 |

**Location（面交地點）枚舉：**
| 值 | 說明 |
|----|------|
| NorthLobby | 北棟管理室 |
| SouthLobby | 南棟管理室 |
| Playground | 風雨操場 |

**Status（商品狀態）枚舉：**
| 值 | 說明 |
|----|------|
| Active | 上架中 |
| Reserved | 保留中 |
| Sold | 已售出 |
| Donated | 已捐贈 |
| Inactive | 已下架 |

### ListingImages（商品圖片）

| 欄位 | 型別 | 說明 |
|------|------|------|
| Id | GUID | 主鍵 |
| ListingId | GUID | FK → Listings |
| ImageUrl | string | Blob 圖片網址 |
| SortOrder | int | 排序（0-4） |
| CreatedAt | DateTime | 上傳時間 |

### Messages（站內私訊）

| 欄位 | 型別 | 說明 |
|------|------|------|
| Id | GUID | 主鍵 |
| SenderId | GUID | FK → Users（發送者） |
| ReceiverId | GUID | FK → Users（接收者） |
| ListingId | GUID? | FK → Listings（關聯商品，選填） |
| Content | string | 訊息內容 |
| IsRead | bool | 是否已讀 |
| CreatedAt | DateTime | 發送時間 |

### Reviews（交易評價）

| 欄位 | 型別 | 說明 |
|------|------|------|
| Id | GUID | 主鍵 |
| ListingId | GUID | FK → Listings（唯一，一筆交易一個評價） |
| SellerId | GUID | FK → Users（賣家） |
| BuyerId | GUID | FK → Users（買家/評價者） |
| Rating | int | 評分（1-5 星） |
| Content | string? | 評價內容（選填） |
| CreatedAt | DateTime | 評價時間 |

> 📌 一個商品只能有一筆評價（ListingId 唯一）
> 📌 只有交易完成（已售出/已捐贈）的商品才能被評價

---

## 頁面規劃

### 頁面清單

| 頁面 | 路由 | 說明 | 需登入 |
|------|------|------|:------:|
| 登入頁 | `/Account/Login` | 帳號密碼 + LINE 登入 | ✗ |
| 註冊頁 | `/Account/Register` | 建立新帳號 | ✗ |
| **商品列表（首頁）** | `/` | 搜尋篩選 + 商品卡片 | ✗ |
| 商品詳情 | `/Listing/{id}` | 商品資訊 + 私訊按鈕 | ✗ |
| 刊登商品 | `/Listing/Create` | 新增商品表單 | ✓ |
| 修改商品 | `/Listing/Edit/{id}` | 編輯商品 + 狀態變更 | ✓ |
| **我的商品** | `/Listing/My` | 個人刊登列表 + 完成交易按鈕 | ✓ |
| **個人帳號** | `/Account/Profile` | 修改資料 + 刪除帳號 | ✓ |
| **信箱** | `/Message` | 對話列表 | ✓ |
| 對話詳情 | `/Message/{oderId}` | 即時聊天 + 完成交易按鈕 | ✓ |

### 頁面流程圖

```
                          ┌─────────────────┐
                          │    訪客進入      │
                          └────────┬────────┘
                                   │
                                   ▼
┌──────────────────────────────────────────────────────────────────┐
│                     商品列表頁（首頁）                             │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ 🔍 搜尋: [____________]  分類: [全部▼]  價格: [__]-[__]     │ │
│  │         狀態: [上架中▼]  ☐ 只看免費  ☐ 只看愛心商品         │ │
│  └─────────────────────────────────────────────────────────────┘ │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐                │
│  │  商品1  │ │  商品2  │ │  商品3  │ │  商品4  │ ...           │
│  │  📷    │ │  📷    │ │  📷    │ │  📷    │                │
│  │  $100  │ │  免費   │ │  $50💝 │ │  $200  │                │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘                │
└──────────────────────────────────────────────────────────────────┘
                                   │
              ┌────────────────────┼────────────────────┐
              │                    │                    │
              ▼                    ▼                    ▼
     ┌────────────────┐   ┌────────────────┐   ┌────────────────┐
     │   商品詳情頁    │   │    登入頁      │   │    註冊頁      │
     │  - 圖片輪播    │   │ [帳號______]   │   │ [帳號______]   │
     │  - 商品資訊    │   │ [密碼______]   │   │ [密碼______]   │
     │  - 賣家評價    │   │ [登入]         │   │ [暱稱______]   │
     │  - [私訊賣家]  │   │ ─── 或 ───    │   │ [Email_____]   │
     └────────────────┘   │ [LINE 登入]    │   │ [註冊]         │
                          └────────────────┘   └────────────────┘


┌─────────────────────────────────────────────────────────────────┐
│                        登入後功能                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────┐   ┌──────────────────────────────────────┐    │
│  │   刊登商品    │   │            我的商品                   │    │
│  │   (Create)   │   │  ┌────────┐ ┌────────┐ ┌────────┐   │    │
│  └──────────────┘   │  │ 商品A  │ │ 商品B  │ │ 商品C  │   │    │
│                      │  │ 上架中 │ │ 保留中 │ │ 已售出 │   │    │
│                      │  │ [編輯] │ │ [編輯] │ │  ⭐⭐⭐ │   │    │
│                      │  │ [保留] │ │[完成]  │ │        │   │    │
│                      │  │ [下架] │ │[取消]  │ │        │   │    │
│                      │  └────────┘ └────────┘ └────────┘   │    │
│                      └──────────────────────────────────────┘    │
│                                                                  │
│  ┌──────────────┐   ┌──────────────┐                            │
│  │   個人帳號    │   │    信箱      │                            │
│  │  (Profile)  │   │  (對話列表)  │                            │
│  └──────────────┘   └───────┬──────┘                            │
│  │ - 修改暱稱/Email        │                                    │
│  │ - 綁定/解除 LINE        ▼                                    │
│  │ - 修改密碼       ┌──────────────┐                            │
│  │ - 🗑️ 刪除帳號   │   對話詳情    │  ← SignalR 即時通訊        │
│  └──────────────┘   │  [完成交易]  │                            │
│                      └──────────────┘                            │
└─────────────────────────────────────────────────────────────────┘
```

### 個人帳號頁面

```
┌─────────────────────────────────────────┐
│           👤 個人帳號設定                │
├─────────────────────────────────────────┤
│                                         │
│  帳號:      andy123 (不可修改)          │
│  暱稱:      [Andy______________] ✏️     │
│  Email:    [andy@example.com___] ✏️     │
│                                         │
│  ─────────────────────────────────      │
│                                         │
│  LINE 綁定: ✅ 已綁定  [解除綁定]        │
│       或:   ❌ 未綁定  [綁定 LINE]       │
│                                         │
│  ─────────────────────────────────      │
│                                         │
│  修改密碼:  [修改密碼]                   │
│                                         │
│  ─────────────────────────────────      │
│                                         │
│  ⚠️ 危險區域                            │
│  [🗑️ 刪除帳號]                          │
│  刪除後所有資料將無法復原                │
│                                         │
└─────────────────────────────────────────┘
```

---

## 專案結構

```
NeighborGoods/
├── Controllers/           # MVC Controllers
│   ├── HomeController.cs
│   ├── AccountController.cs
│   ├── ListingController.cs
│   ├── MessageController.cs
│   └── AdminController.cs
│
├── Models/                # 實體 + ViewModel
│   ├── Entities/          # 資料庫實體
│   │   ├── User.cs
│   │   ├── Listing.cs
│   │   ├── ListingImage.cs
│   │   ├── Message.cs
│   │   └── Review.cs
│   ├── Enums/             # 枚舉定義
│   │   ├── UserRole.cs
│   │   ├── Category.cs
│   │   ├── Condition.cs
│   │   ├── Location.cs
│   │   └── ListingStatus.cs
│   └── ViewModels/        # 頁面 ViewModel
│
├── Data/                  # 資料存取
│   └── AppDbContext.cs
│
├── Services/              # 業務邏輯
│   ├── BlobService.cs
│   └── LineAuthService.cs
│
├── Hubs/                  # SignalR Hub
│   └── ChatHub.cs
│
├── Views/                 # Razor Views
│   ├── Home/
│   ├── Account/
│   ├── Listing/
│   ├── Message/
│   └── Shared/
│
├── wwwroot/               # 靜態資源
│   ├── css/
│   ├── js/
│   └── images/
│
├── appsettings.json
└── Program.cs
```

---

## 快速開始

### 前置需求

- [.NET 8 SDK](https://dotnet.microsoft.com/download/dotnet/8.0)
- [SQL Server LocalDB](https://docs.microsoft.com/sql/database-engine/configure-windows/sql-server-express-localdb) 或 Docker
- [Azurite](https://docs.microsoft.com/azure/storage/common/storage-use-azurite)（本地 Blob 模擬）

### 本地開發

```bash
# 1. 複製專案
git clone https://github.com/YOUR_ORG/neighborgoods.git
cd neighborgoods

# 2. 還原套件
dotnet restore

# 3. 設定本地機密
dotnet user-secrets set "ConnectionStrings:DefaultConnection" "Server=(localdb)\\mssqllocaldb;Database=NeighborGoods;Trusted_Connection=True;"
dotnet user-secrets set "AzureBlob:ConnectionString" "UseDevelopmentStorage=true"

# 4. 執行資料庫遷移
dotnet ef database update

# 5. 啟動 Azurite
azurite --silent &

# 6. 啟動應用程式
dotnet run
```

---

## 里程碑

### M1 - 核心功能 ✨
- [ ] 使用者登入（帳號密碼 + LINE）
- [ ] 商品刊登 CRUD
- [ ] 圖片上傳至 Blob
- [ ] 商品列表與詳情頁
- [ ] 商品狀態管理（上架/保留/完成交易/下架）

### M2 - 即時通訊與評價 💬
- [ ] 站內私訊（SignalR 即時）
- [ ] 未讀訊息提醒
- [ ] 交易評價系統
- [ ] 賣家評分顯示

### M3 - 愛心捐贈與管理 💝
- [ ] 愛心商品標註
- [ ] 公益團體認領流程
- [ ] 版主強制下架功能
- [ ] 管理員後台
- [ ] 公益團體帳號審核

---

## 授權條款

本專案採用 MIT 授權條款。

---

<div align="center">

**Made with ❤️ for Community**

</div>
